Let $R$ be a ring and $S$ be a domain.
Find all functions $f : R \to S$ such that, for any $x, y \in R$,
\[ f(xy + 1) = f(x) f(y) + f(x + y). \tag{*}\label{2012a5-eq0} \]

\textbf{Warning.}
The original problem uses the above functional equation with $R = S = \R$ and an extra condition, $f(-1) \neq 0$.
This problem is an extreme buffed version of the original problem.
The difficulty level of this problem is far beyond the level of IMO.
Proceed with caution; the solution might be very hard to understand.







\subsection*{Answer}

Before proceeding, note the following.
Given a good function $f : R \to S$ and homomorphisms $\phi : R' \to R$ and $\iota : S \to S'$, it is easy to check that $\iota \circ f \circ \phi$ is good.
The functions we will list below are the "initial" functions.
All good functions are of form $\phi \circ f \circ \iota$ where $f$ is a good function on the list.
Here is the list of initial functions:

\begin{itemize}
    \item   The zero function.
    \item   The function $x \in R \mapsto x - 1$ on a ring $R$.
    \item   The function $x \in R \mapsto x^2 - 1 \in R_2$, where $R$ is a commutative ring and $R_2$ is the subring of $R$ generated by squares.
    \item   One of the six functions below:
    \begin{align*}
        \F_2 &\to \Z    & \F_3 &\to \Z    & \F_3 &\to \Z    & \Z/4\Z &\to \Z  & \F_2[X]/\langle X^2 \rangle &\to \Z   & \F_4 &\to \Z[\varphi] \\
        0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1                         & 0 &\mapsto -1 \\
        1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0                          & 1 &\mapsto 0  \\
                       && 2 &\mapsto 1    & 2 &\mapsto 0    & 2 &\mapsto 1    & X &\mapsto 1                          & X &\mapsto \varphi  \\
                                                       &&&&&& 3 &\mapsto 0    & X + 1 &\mapsto 0                      & X + 1 &\mapsto 1 - \varphi
    \end{align*}
    For the last function, $\varphi$ is the golden ratio $\frac{1 + \sqrt{5}}{2}$.
\end{itemize}







\subsection*{Solution}

It is easy to check that the zero function and $x \mapsto x - 1$ are good.
To check the third function, it suffices to check that $x \mapsto x^2 - 1$ on a commutative ring is good, which can be bashed.
Finally, the six functions in the above table have finite input ring, so again we can bash to verify that they are all good functions.
Now we focus on proving that there are no other good functions.

We say that a good function $f : R \to S$ is \emph{non-trivial good} if $f(0) = -1$.
Note that by~\eqref{2012a5-eq0}, this also implies $f(1) = 0$.
We say that $f$ is \emph{reduced good} if $f$ is non-trivial and $f$ has no non-zero periodic element.
That is, $f(x + c) = f(x + d)$ for all $x \in R$ implies $c = d$.

We start with some easy observations.
Plugging $x = y = 1$ yields $f(1) = 0$.
Then plugging $y = 0$ yields either $f \equiv 0$ and $f(0) = -1$.
That is, if $f$ is not the zero function, then $f$ is non-trivial good.
We now continue with more observations.



\subsubsection*{Quasi-periodic elements}

We say that $c \in R$ is \emph{quasi-periodic} if one of the following conditions hold:
\begin{itemize}
    \item   $f(c + x) = -f(c) f(x)$ for all $x \in R$,
    \item   $f(cx + 1) = 0$ for all $x \in R$,
    \item   $f(x + c) = -f(x) f(c)$ for all $x \in R$,
    \item   $f(xc + 1) = 0$ for all $x \in R$.
\end{itemize}

Actually, we will show shortly that these four conditions are all equivalent.
Indeed, by~\eqref{2012a5-eq0}, the first two and the last two are equivalent.
For the first and third, we prove a more general result.

\begin{claim}
For any $c \in R$ satisfying the first or the third condition, we have $f(c) = f(-c) = \pm 1$.
\end{claim}
\begin{proof}
By symmetry, we can assume that $c \in R$ satisfies the first condition.
Then $f(c + 1) = -f(c) f(1) = 0$, and so~\eqref{2012a5-eq0} with $(x, y) = (c + 1, -1)$ yields $f(-c) = f(c)$.
For the last equality, note that $-f(c)^2 = -f(c) f(-c) = f(0) = -1$.
Thus we get $f(c)^2 = 1 \iff f(c) = \pm 1$.
\end{proof}

In particular, $f(c)$ always commutes with $f(x)$.
This shows that the first and third condition are indeed equivalent.
Thus, all four conditions are indeed equivalent.

Now let $J \subseteq R$ be the set of quasi-periodic elements.
The first condition yields that $J$ is closed under addition.
The second and fourth condition yields that $J$ is closed under right and left multiplication by elements of $R$, respectively.
Thus, $J$ is a two-sided ideal of $R$.

\begin{lemma}\label{2012a5-quasi-periodic-non-zero}
Suppose that $f$ is reduced and $J$ contains a non-zero element, say $c$.
Then $R = \{0, 1, c, c + 1\}$.
\end{lemma}
\begin{proof}
First note that $f(c) = \pm 1$ for any $c \in J$.
If $f(c) = -1$, then $f(x + c) = f(x)$ for all $x \in R$ and thus $c = 0$.
Thus, if $c \in J$ is non-zero, then $f(c) = 1$.
This case is possible only if $\rchar(S) \nmid 2$, so we will assume this.

Now fix a non-zero element $c \in J$.
Then $f(c) = 1$, and so $f(x + c) = -f(x)$ for all $x \in R$.
For any $d \in J$ non-zero, this yields $1 = f(d) = -f(d - c)$.
So $f(d - c) = -1$ and so, since $d - c \in J$, this implies $d = c$.
In summary, $J = \{0, c\}$.

Next, we show that for any $d \in R$, if $dc = 0$, then $d \in J$.
Indeed, for any $x \in R$, we have
\[ f(dx + 1) = f(d(x + c) + 1) = f(d) f(x + c) + f(d + x + c) = -(f(d) f(x) + f(d + x)) = -f(dx + 1). \]
Since $\rchar(S) \nmid 2$, this means $f(dx + 1) = 0$ for all $x \in J$.
Thus $d \in J$, as desired.

Finally, for any $r \in R$, we have $rc \in J = \{0, c\}$, so either $rc = 0$ or $(r - 1)c = 0$.
By the above result, the former yields $r \in \{0, c\}$, and the latter yields $r \in \{1, c + 1\}$.
\end{proof}



\subsubsection*{Periodic elements}

Consider the set $I$ of periodic elements of $R$ (with respect to $f$).
That is, \[ I = \{c \in R : \forall x \in R, f(x + c) = f(x)\}. \]
Here, we prove that $I$ is in fact a double-sided ideal of $R$.
Clearly $I$ is a group under addition, so we just have to prove that it is closed under multiplication from both sides.
By symmetry, it suffices to show that $dc \in I$ for any $d \in R$ and $c \in I$.

Let $J$ be the ideal of quasi-periodic elements as in the previous part.
Clearly, $c \in I$ implies $f(c) = f(0) = -1$ and $c \in J$.
The converse is easy to check, so we have
\[ c \in I \iff c \in J \wedge f(c) = -1. \]

Now fix $c \in I$ and $d \in R$; the goal is to show that $dc \in I$.
Since $J$ is a two-sided ideal, we have $dc \in J$ and thus $f(dc) = \pm 1$.
The goal is to show that $f(dc) = -1$.

\begin{proof}
Since $c \in I$, for any $x \in R$ we have
\[ f(d) f(c + x) + f(d + c + x) = f(d) f(x) + f(d + x) \implies f(dc + dx + 1) = f(dx + 1). \]
But $dc \in J$, so this gives us $-f(dx + 1) = f(dx + 1)$.
Thus, either $\rchar(S) = 2$ or $f(dx + 1) = 0$ for all $x \in R$.
In the former case, we are done since $f(dc) = \pm 1 = -1$.
The latter case means that $d \in J$.
Thus, for any $d \in R$, either $dc \in I$ or $d \in J$.

Now if $d \in J$, then $d - 1 \notin J$, so $(d - 1)c \in I$.
Since $c \in I$, we still get $dc \in I$.
Either way, we have $dc \in I$ for any $d \in R$, as desired.
\end{proof}

Since $I$ is a two-sided ideal and $f(x + c) = f(x)$ for any $c \in I$, $f$ lifts to a function $\tilde{f} : R/I \to S$.
That is, $\tilde{f}$ satisfies $f = \tilde{f} \circ q$, where $q : R \to R/I$ is the canonical quotient map.
One can check that $\tilde{f}$ is a reduced good map.
Using this result, from now on, we can assume that $f$ is a reduced good map whenever necessary.



\subsubsection*{A solver for $f(x + 1) = f(x) + 1$.}

We now solve the problem when $f(x + 1) = f(x) + 1$ for all $x \in R$.
The result is as follows:

\begin{lemma}\label{2012a5-linear-solver}
Let $f : R \to S$ be a non-trivial good map such that $f(x + 1) = f(x) + 1$ for all $x \in R$.
Then $f + 1$ is a ring homomorphism.
\end{lemma}
\begin{proof}
First we reduce the lemma to showing that $f + 1$ is additive.
Equivalently, $f(x + y) = f(x) + f(y) + 1$ for all $x, y \in R$.
Indeed, if $f + 1$ is additive, then for any $x, y \in R$,
\[ f(xy) + 1 = f(xy + 1) = f(x) f(y) + f(x + y) = f(x) f(y) + f(x) + f(y) + 1 = (f(x) + 1)(f(y) + 1). \]
Thus $f + 1$ is multiplicative.
Since $f(1) + 1 = 1$, this would prove that $f + 1$ is a ring homomorphism.
Before proceeding, note that for any $x, y \in R$,
\[ f(xy) = f(xy + 1) - 1 = f(x) f(y) + f(x + y) - 1. \]

Now fix $x, y \in R$; we show that $f(x + y) = f(x) + f(y) + 1$.
The trick is to write $f(x(x + 1) y + 1)$ in two ways.
Let $a = f(x)$, $b = f(y)$, and $c = f(x + y)$, and note again that $f(x + 1) = f(x) + 1$ for all $x \in R$.
We get
\begin{align*}
    a f((x + 1) y) + f(x + (x + 1) y) &= (a + 1) f(xy) + f(x + 1 + xy) \\
    a((a + 1) b + c) + (a + 1)(b + 1) + c &= (a + 1) (ab + c - 1) + a(b + 1) + c + 1
\end{align*}
    which simplifies to $c = a + b + 1$ after some heavy algebraic manipulation.
It is the desired equality.
\end{proof}



\subsubsection*{Case 1: $f(-1) \neq 0$}

By replacing $(x, y)$ with $(x + 1, -1)$ in~\eqref{2012a5-eq0}, we get
\[ f(-x) = f(x + 1) f(-1) + f(x). \tag{1.1}\label{2012a5-eq1-1} \]
Using~\eqref{2012a5-eq1-1} twice yields $f(x) = f(-x) + f(-x + 1) f(-1) = f(-x) - f(x + 1) f(-1)$.
Since $f(-1) \neq 0$, this gives us $f(-x + 1) = -f(x + 1)$, or
\[ f(-x) = -f(x + 2). \tag{1.2}\label{2012a5-eq1-2} \]
In particular, $f(2) = 1$.
Now we prove more equalities.

By comparing $(x, y)$ with $(-x, -y)$, we get
\[ f(-x) f(-y) + f(-(x + y)) = f(x) f(y) + f(x + y). \tag{1.3}\label{2012a5-eq1-3} \]
By plugging $y = 2$ into~\eqref{2012a5-eq0} and using~\eqref{2012a5-eq1-2}, we get
\[ f(2x + 1) = f(x) - f(-x). \tag{1.4}\label{2012a5-eq1-4} \]

Now we show that for any $x \in R$,
\[ f(x + 1) = 0 \vee f(-x) + f(x) = f(-1), \tag{1.5}\label{2012a5-eq1-5} \]
By~\eqref{2012a5-eq1-3} with $y = x$, we get
\[ f(x)^2 - f(-x)^2 = f(-2x) - f(2x). \]
Since $x$ and $-x$ commute, so does $f(x)$ and $f(-x)$.
Thus the LHS factors as $(f(x) - f(-x))(f(x) + f(-x))$.
Applying~\eqref{2012a5-eq1-4} on the LHS and~\eqref{2012a5-eq1-1} on the RHS gives
\[ f(2x + 1) (f(x) + f(-x)) = f(2x + 1) f(-1). \]
Thus either $f(2x + 1) = 0$ or $f(x) + f(-x) = f(-1)$.
But combining~\eqref{2012a5-eq1-4} and~\eqref{2012a5-eq1-1} yields $f(2x + 1) = -f(x + 1) f(-1)$.
Since $f(-1) \neq 0$, $f(2x + 1) = 0$ implies $f(x + 1) = 0$, as desired.

Next, we show that
\[ f(x + 1) = 0 \implies f(-x) = f(x) = -1. \tag{1.6}\label{2012a5-eq1-6} \]
First note that~\eqref{2012a5-eq1-1} already gives $f(-x) = f(x)$.
Now~\eqref{2012a5-eq1-3} with $y = -(x + 1)$ gives
\[ f(x) f(-(x + 1)) + f(-1) = 0 \iff f(x) f(-(x + 1)) = -f(-1). \]
Meanwhile, with $y = x + 1$, we get
\[ f(-x) f(-(x + 1)) + f(-(2x + 1)) = f(2x + 1). \]
Note that $f(-x) = f(x)$, so applying the previous equality and using~\eqref{2012a5-eq1-4} gives
\[ -f(-1) - f(-x) f(-1) = -f(x + 1) f(-1) = 0. \]
Since $f(-1) \neq 0$, this gives $f(-x) = -1$.
This proves~\eqref{2012a5-eq1-6}.

\begin{claim}
We have $f(-1) \in \{-2, 1\}$.
\end{claim}
\begin{proof}
Recall that $f(2) = 1$.
By~\eqref{2012a5-eq0} with $x = y = -1$, we have $f(-2) = 1 - f(-1)^2$.
By~\eqref{2012a5-eq1-5} with $x = -2$, since $f(-1) \neq 0$, we have $f(-2) = f(-1) - 1$.
Thus we have $1 - f(-1)^2 = f(-1) - 1$, which implies the claim.
\end{proof}

We now split cases based on the value of $f(-1)$.

\begin{itemize}

    \item
    $f(-1) = -2$ and $\rchar(S) \nmid 2$.
    
    Then combining~\eqref{2012a5-eq1-5} with~\eqref{2012a5-eq1-6} yields $f(-x) + f(x) = -2$ for all $x \in R$.
    Combining with~\eqref{2012a5-eq1-1} now gives $2 f(x + 1) = 2 (f(x) + 1)$ for all $x \in R$.
    Since $\rchar(S) \nmid 2$, this gives us $f(x + 1) = f(x) + 1$ for all $x \in R$.
    We are done by Lemma~\ref{2012a5-linear-solver}.


    \item
    $f(-1) = 1$ and $\rchar(S) \nmid 3$.

    We will assume that $f$ is reduced in this subcase.
    We start by strengthening~\eqref{2012a5-eq1-6}: $f(x + 1) = 0$ implies $x = 0$.
    Indeed, $f(-x) = f(x) = -1$, so~\eqref{2012a5-eq1-3} yields
    \[ -f(-y) + f(-(x + y)) = -f(y) + f(x + y) \iff f(-(x + y)) - f(x + y) = f(-y) - f(y). \]
    By~\eqref{2012a5-eq1-1} and $f(-1) \neq 0$, we get $f(x + y + 1) = f(y + 1)$ for all $y \in R$.
    Replace $y$ with $y - 1$, and we get that $f$ is $x$-periodic, thus $x = 0$.

    By~\eqref{2012a5-eq1-5}, we have $f(-x) + f(x) = 1$ if $x \neq 0$.
    By~\eqref{2012a5-eq1-1} and~\eqref{2012a5-eq1-2}, we get $f(x) + f(x + 1) + f(x + 2) = 0$ for all $x \in R$.
    Thus, it is clear that $f$ is $3$-periodic, hence $\rchar(R) \mid 3$.
    Next, for any $x \in R$,
    \[ f(x) + f(x + 1) + f(x + 2) + f(-x) + f(-(x + 1)) + f(-(x + 2)) = 0. \]
    If $x \notin \{0, 1, 2\}$, then we would have $3 = 0$ in $S$, contradicting $\rchar(S) \nmid 3$.
    Thus, $R = \{0, 1, 2\}$, and it is easy to check now that $R \cong \F_3$.
    The isomorphism then induces the second map ($\F_3 \to \Z$) on the table.

\end{itemize}



\subsubsection*{Case 2: $f(-1) = 0$, $\rchar(R) \nmid 2$}

Plugging $y = -1$ into~\eqref{2012a5-eq0} immediately implies that $f$ is even.
In particular, by replacing $y$ with $-y$ in~\eqref{2012a5-eq0} yields
\[ f(xy - 1) = f(x) f(y) + f(x - y). \tag{2.1}\label{2012a5-eq2-1} \]
By applying~\eqref{2012a5-eq0} with $(x - 1, 2)$, for any $x \in R$,
\[ f(2x - 1) = f(x - 1) f(2) + f(x + 1). \tag{2.2}\label{2012a5-eq2-2} \]
If we replace $x$ with $-x$ and use the fact that $f$ is even, we get
\[ f(2x + 1) = f(x + 1) f(2) + f(x - 1). \tag{2.3}\label{2012a5-eq2-3} \]
For the next equality, we use the identity $x(x + 1) - 1 = (x + 2)(x - 1) + 1$.
Thus, for any $x \in R$,
\[ f(x) f(x + 1) = f(x + 2) f(x - 1) + f(2x + 1). \]
Adding $f(x) f(2) f(x - 1)$ on both sides and using~\eqref{2012a5-eq0} and~\eqref{2012a5-eq2-2} gives
\[ f(x) f(2x - 1) = (f(x - 1) + 1) f(2x + 1). \tag{2.4}\label{2012a5-eq2-4} \]

Next, we show that
\[ f(x) = f(x + 1) = 0 \implies 2x + 1 = 0. \tag{2.5}\label{2012a5-eq2-5} \]
The main idea is to break down $f(x(x + 1)y + 1)$ in two ways using~\eqref{2012a5-eq0}.
This gives us
\[ f((x + 1)(y + 1) - 1) = f((x + 1) y + x) = f(xy + x + 1) = f(x(y + 1) + 1) \implies f(y - x) = f(x + y + 1). \]
Replacing $y$ with $x + y$, we get $f(y + 2x + 1) = f(y)$ for any $y \in R$.
Thus $2x + 1 = 0$, proving~\eqref{2012a5-eq2-5}.

We now use~\eqref{2012a5-eq2-5} to derive important equalities.
First, if $f(2) = -1$, then~\eqref{2012a5-eq2-2} and~\eqref{2012a5-eq2-3} yields $f(2x + 1) = -f(2x - 1)$.
As a result,~\eqref{2012a5-eq2-4} yields that for any $x \in R$, either $f(x) + f(x - 1) = -1$ or $f(2x - 1) = 0$.
If $f(x) + f(x - 1) = f(x + 1) + f(x) = -1$, then clearly $f(x + 1) = f(x - 1)$.
Otherwise, we have $f(2x - 1) = 0$ or $f(2x + 1) = 0$.
By~\eqref{2012a5-eq2-2} and~\eqref{2012a5-eq2-3}, respectively, they yield $f(x + 1) = f(x - 1)$.
As this holfs for all $x$, we get $\rchar(R) \mid 2$; a contradiction.
From now on, we have $f(2) \neq -1$.

Consider~\eqref{2012a5-eq2-4} with $x$ replaced by $-x$:
\[ f(x) f(2x + 1) = f(2x - 1) (f(x + 1) + 1). \]
Subtract with~\eqref{2012a5-eq2-4}, then apply~\eqref{2012a5-eq2-2} and~\eqref{2012a5-eq2-3}.
Rearranging after that gives us
\[ f(x + 1) + f(x - 1) = (f(2) - 1)(f(x) + 1) \vee f(x + 1) = f(x - 1). \]
By comparing~\eqref{2012a5-eq2-3} and~\eqref{2012a5-eq0}, we have $f(x) f(2) + f(x + 2) = f(x + 1) f(2) + f(x - 1)$.
Thus, the former equality also follows if $f(x + 2) + f(x) = (f(2) - 1)(f(x + 1) + 1)$ holds.
Otherwise, we would have $f(x + 1) = f(x - 1)$ and $f(x) = f(x + 2)$.
But then we get $f(2x + 1) = (f(2) + 1) f(x - 1) = (f(2) + 1) f(x)$.
Since $f(2) \neq -1$, we get $f(x + 1) = f(x) = f(x - 1) = 0$.
By~\eqref{2012a5-eq2-5}, we get $2x + 1 = 2x - 1 = 0$, so $2 = 0$ in $R$; a contradiction.
This shows that for any $x \in R$,
\[ f(x + 1) + f(x - 1) = (f(2) - 1)(f(x) + 1). \tag{2.6}\label{2012a5-eq2-6} \]

For the next equality, instead of subtracting, we multiply the two equations (almost).
The two equations give us
\[ (f(x + 1) + 1)(f(x - 1) + 1) f(2x - 1) = (f(x - 1) + 1) f(x) f(2x + 1) = f(x)^2 f(2x - 1). \]
If $f(2) \neq 1$ and $f(2x - 1) = f(2x + 1) = 0$, then $f(x + 1) = f(x - 1) = 0$.
By~\eqref{2012a5-eq2-6}, we get $f(x) = -1$.
So, if $f(2) \neq 1$, in all cases, we have
\[ (f(x + 1) + 1)(f(x - 1) + 1) = f(x)^2. \tag{2.7}\label{2012a5-eq2-7} \]

\begin{claim}
We have $f(2) \in \{0, 1, 3\}$.
\end{claim}
\begin{proof}
For convenience, let $f(2) = C$.
By~\eqref{2012a5-eq2-1}, we have $f(5) = C f(3)$.
By~\eqref{2012a5-eq2-6}, we have $f(5) = (C - 1)(f(4) + 1) - f(3)$ and
\[ f(4) = (C - 1)(f(3) + 1) - C \implies f(4) + 1 = (C - 1) f(3). \]
Thus we get
\[ C f(3) = f(5) = (C - 1)^2 f(3) - f(3) = (C^2 - 2C) f(3) \implies f(3) = 0 \vee C = 0 \vee C = 3. \]
But~\eqref{2012a5-eq2-1} gives $f(3) = C^2 - 1$, so $f(3) = 0$ implies $C = \pm 1$.
Since the case $f(2) = -1$ is already excluded, the claim is proved.
\end{proof}

We now split cases based on the possible values of $f(2)$.

\begin{itemize}

    \item 
    $f(2) = 1$ and $\rchar(S) \nmid 2$.

    Then~\eqref{2012a5-eq2-6} yields $f(x + 2) = -f(x)$ for any $x \in R$.
    Then $f$ is $4$-periodic, and $2$ is quasi-periodic!
    By Lemma~\ref{2012a5-quasi-periodic-non-zero}, we get $R \cong \Z/4\Z$.
    The isomorphism then induces the fourth map ($\Z/4\Z \to \Z$) on the table.

    \item
    $f(2) = 0$ and $\rchar(S) \nmid 3$.

    In this case,~\eqref{2012a5-eq2-6} simplifies as
    \[ f(x + 1) + f(x - 1) + f(x) = -1. \tag{2.2.1}\label{2012a5-eq2-2-1} \]
    In particular, $f$ is $3$-periodic, so $\rchar(R) \mid 3$.
    Also,~\eqref{2012a5-eq2-7} simplifies as
    \[ f(x + 1) f(x - 1) = f(x)^2 + f(x). \tag{2.2.2}\label{2012a5-eq2-2-2} \]
    Now notice that, by either~\eqref{2012a5-eq0} or~\eqref{2012a5-eq2-1},
    \[ f(x^2 + 1) = f(x)^2 + f(x), \quad f(x^2 - 1) = f(x)^2 - 1, \quad f(x^2) = f(x + 1) f(x - 1) + f(2x) = f(x)^2 + 2 f(x). \]
    Adding the three equations yield $3 f(x)^2 + 3 f(x) - 1 = -1$, so $f(x) \in \{-1, 0\}$ for all $x \in R$.
    By~\eqref{2012a5-eq2-2-1} and~\eqref{2012a5-eq2-2-2}, since $\rchar(S) \nmid 3$, exactly one of $f(x)$, $f(x + 1)$, and $f(x - 1)$ is equal to $-1$, and the other two equals $0$.
    If $f(x) = -1$, then $f(x + 1) = f(x - 1) = 0$.
    Since $\rchar(R) \mid 3$,~\eqref{2012a5-eq2-5} yields $x = 0$.
    Thus $R \cong \F_3$, and the isomorphism then induces the third map ($\F_3 \to \Z$) on the table.

    \item
    $f(2) = 3$ and $\rchar(S) \nmid 2$.

    For convenience, denote $g(x) = f(x) + 1$.
    This time,~\eqref{2012a5-eq2-6} simplifies as
    \[ g(x + 1) + g(x - 1) = 2 g(x) + 2, \tag{2.3.1}\label{2012a5-eq2-3-1} \]
    Subtracting~\eqref{2012a5-eq2-1} from~\eqref{2012a5-eq0} yields that for any $x, y \in R$,
    \[ g(xy + 1) - g(xy - 1) = g(x + y) - g(x - y). \tag{2.3.2}\label{2012a5-eq2-3-2} \]
    Next,~\eqref{2012a5-eq2-7} simplifies as
    \[ g(x + 1) g(x - 1) = (g(x) - 1)^2. \]
    Note that $(g(x + 1) - g(x - 1))^2 = (g(x + 1) + g(x - 1))^2 - 4 g(x + 1) g(x - 1)$.
    Thus, using the above equation and~\eqref{2012a5-eq2-3-1} yields
    \[ (g(x + 1) - g(x - 1))^2 = 16 g(x). \]
    More generally, due to~\eqref{2012a5-eq2-3-2}, for any $x, y \in R$,
    \[ (g(x + y) - g(x - y))^2 = 16 g(xy). \tag{2.3.3}\label{2012a5-eq2-3-3} \]
    Adding~\eqref{2012a5-eq0} with~\eqref{2012a5-eq2-1} and then using~\eqref{2012a5-eq2-3-1} yields
    \[ 2 f(xy) + 2 = 2 f(x) f(y) + f(x + y) + f(x - y), \]
        which rearranges in terms of $g$ to
    \[ 2(g(xy) - g(x) g(y)) = g(x + y) + g(x - y) - 2(g(x) + g(y)). \tag{2.3.4}\label{2012a5-eq2-3-4} \]
    Another useful equality follows by adding~\eqref{2012a5-eq2-2} and~\eqref{2012a5-eq2-3}, and applying~\eqref{2012a5-eq2-3-1}:
    \[ g(2x) = 4 g(x). \tag{2.3.5}\label{2012a5-eq2-3-5} \]
    Next, we show that for any $x \in R$,
    \[ g(x) = 0 \implies x = 0. \tag{2.3.6}\label{2012a5-eq2-3-6} \]

    \begin{proof}
    First of all,~\eqref{2012a5-eq2-3-3} yields $g(x + 1) = g(x - 1)$.
    Then~\eqref{2012a5-eq2-3-1} yields $g(x + 1) = g(x - 1) = 1$, or $f(x + 1) = f(x - 1) = 0$.
    Now, for any $y \in R$, consider writing $f(x(x + 1)y + 1)$ in two ways using~\eqref{2012a5-eq0} and~\eqref{2012a5-eq2-1}:
    \[ f(x(x + 1)y + 1) = f((x + 1)y + x) - f((x + 1)y) = f((x + 1)(y + 1) - 1) - f((x + 1)y) = f(y - x) - f((x + 1)y), \]
    \[ f(x(x + 1)y + 1) = f(xy + x + 1) = f(x + y + 1) - f(y + 1). \]
    Now write both sides in terms of $g$ again:
    \[ g(y - x) - g((x + 1)y) = g(x + y + 1) - g(y + 1). \]
    Multiply both sides by $2$, then apply~\eqref{2012a5-eq2-3-4}:
    \[ 2 g(y - x) - (g(y + 1 + x) + g(y - 1 - x) - 2) = 2 g(y + 1 + x) - 2 g(y + 1), \]
        which rearranges to
    \[ 2 (g(y - x) + 1) - g(y - 1 + x) = 3 g(y + 1 + x) - 2 g(y + 1). \]
    By~\eqref{2012a5-eq2-3-1} and replacing $y$ with $y - 1$, we get
    \[ g(y - x) = 3 g(y + x) - 2 g(y) \iff g(y - x) + 2 g(y) = 3 g(y + x). \]
    By replacing $y$ with $-y$ and using the fact that $g$ is even, we get $g(y + x) + 2 g(y) = 3 g(y - x)$.
    Solving these yields $g(y - x) = g(y + x) = g(y)$ for any $y \in R$, since $\rchar(S) \neq 2$.
    This shows that $x = 0$.
    \end{proof}

    Now we show that $R$ is commutative, using~\eqref{2012a5-eq2-3-6}.
    By~\eqref{2012a5-eq2-3-3}, we have $g(xy) = g(yx)$ for all $x, y \in R$.
    Thus, $g((x + y)(x - y)) = g((x - y)(x + y))$, and~\eqref{2012a5-eq2-3-3} yields
    \[ g((x^2 - y^2)(xy - yx)) = 0 \implies (x^2 - y^2)(xy - yx) = 0. \]
    Now we take differences.
    First, $((x + 1)^2 - y^2)(xy - yx) = (x^2 - y^2)(xy - yx) = 0$, so $(2x - 1)(xy - yx) = 0$.
    Taking another difference yields $2(xy - yx) = 0$.
    Substituting back into $(2x - 1)(xy - yx) = 0$ yields $xy - yx = 0$ for all $x, y \in R$.
    This shows that $R$ is commutative.

    Now we are ready to show that both sides of~\eqref{2012a5-eq2-3-4} are zero.
    That is, we have
    \[ g(xy) = g(x) g(y), \tag{2.3.7}\label{2012a5-eq2-3-7} \]
    \[ g(x + y) + g(x - y) = 2(g(x) + g(y)). \tag{2.3.8}\label{2012a5-eq2-3-8} \]

    \begin{proof}
    Consider~\eqref{2012a5-eq2-3-4} but with $x$ replaced by $x + 1$ and $x - 1$.
    Using linear combination of $(x + 1, y) + (x - 1, y) - 2 \cdot (x, y)$, it yields
    \[ 2 (g((x + 1) y) + g((x - 1) y) - 2 g(xy) - 2 g(y)) = 0 \implies g((x + 1) y) + g((x - 1) y) - 2 g(xy) = 2 g(y). \]
    In particular, plugging back into~\eqref{2012a5-eq2-3-4} yields $g(xy^2) = g(xy) g(y)$ for all $x, y \in R$.
    Since $R$ is commutative,
    \[ g(x^2 y^2) = g((xy)^2) \implies g(xy) g(x) g(y) = g(xy)^2 \implies g(xy) = 0 \vee g(xy) = g(x) g(y). \]
    By~\eqref{2012a5-eq2-3-6}, the former yields $xy = 0$.
    It remains to show that $xy = 0$ actually yields either $x = 0$ or $y = 0$.

    If $xy = 0$ and $(x + 1) y = 0$ or $(x - 1) y = 0$, then clearly we are done.
    Otherwise, we have $xy = 0$, $g(y) = g((x + 1) y) = g(x + 1) g(y)$, and $g(y) = g((x - 1) y) = g(x - 1) g(y)$.
    Then adding them and applying~\eqref{2012a5-eq2-3-1} yields $2 g(y) = 2 (g(x) + 1) g(y)$, which implies either $g(x) = 0$ or $g(y) = 0$.
    By~\eqref{2012a5-eq2-3-6} again, we are done.
    \end{proof}

    So now, we have all of~\eqref{2012a5-eq2-3-3},~\eqref{2012a5-eq2-3-7}, and~\eqref{2012a5-eq2-3-8}, and also $R$ is commutative.
    There is a general theory of functions satisfying~\eqref{2012a5-eq2-3-8}; we are going to describe them here now.
    
    \begin{claim}
    There exists a symmetric $\Z$-bilinear map $T : R \times R \to S$ such that $2 g(x) = T(x, x)$ for any $x \in R$.
    \end{claim}
    \begin{proof}
    This function $T$ is given by $T(x, y) = g(x + y) - g(x) - g(y)$, which is clearly symmetric.
    To show that it is bilinear, it suffices to show that for any $x, y, z \in R$,
    \[ T(x + y, z) = T(x, z) + T(y, z) \iff g(x + y + z) + g(x) + g(y) + g(z) = g(x + y) + g(y + z) + g(z + x). \]
    Indeed, $\rchar(S) \nmid 2$, so it suffices to show the same equation with a multiple of $2$ on both sides.
    Now it holds since
    \[ 2 g(x + y + z) + 2 g(x) + 2 g(y) + 2 g(z) = g(2x + y + z) + g(y + z) + g(y + z) + g(y - z), \]
    \[ g(2x + y + z) + g(y - z) = 2 g(x + y) + 2 g(x + z). \]
    Adding the two equations give the desired equation.
    \end{proof}

    Furthermore, $g(x + y) - g(x - y) = 4 T(x, y)$ for any $x, y \in R$.
    Now~\eqref{2012a5-eq2-3-2} tells us that in fact $T(x, y) = T(xy, 1)$ for any $x, y \in R$.
    So this means that there exists a $\Z$-linear map (group homomorphism) $\rho : R \to S$ such that $2 g(x) = \rho(x^2)$ for any $x \in R$.
    
    Now let $R_2 \subseteq R$ be the subring generated by squares.
    Then by structural induction, for any $r \in R_2$, there exists $s \in S$ such that $\rho(r) = 2s$.
    Use axiom of choice and define $h : R_2 \to S$ to be the function that sends each $r$ to one such $s$.
    As $\rchar(S) \nmid 2$ and $\rho$ is a group homomorphism, then $h$ is also a group homomorphism.
    Furthermore, $2 h(x^2) = \rho(x^2) = 2 g(x)$, so $g(x) = h(x^2)$ for any $x \in R$.
    By~\eqref{2012a5-eq2-3-7}, we have $h((xy)^2) = h(x^2) h(y^2)$ for any $x, y \in R$.
    By structural induction, this extends to $h(xy) = h(x) h(y)$ for any $x, y \in R_2$.
    Also, $h(1) = g(1) = 1$; this implies that $h : R_2 \to S$ is a ring homomorphism.
    Finally, we recover $f$ by $f(x) = g(x) - 1 = h(x^2) - 1$ for any $x \in R$.
    We are done.

\end{itemize}



\subsubsection*{Case 3: $\rchar(R) \mid 2$}

In this subcase, we rely on the following three equations deduced from~\eqref{2012a5-eq0}:
\[ f(x^2 + x + 1) = f(x) f(x + 1) \tag{3.1}\label{2012a5-eq3-1} \]
\[ f(x^2 + 1) = f(x)^2 - 1 \tag{3.2}\label{2012a5-eq3-2} \]
The above also gives $f(x^2) = f(x + 1)^2 - 1$ for any $x \in R$.
Next, comparing~\eqref{2012a5-eq0} using $(x, x^2 + x)$ and $(x^2, x + 1)$ yields
\[ f(x) f(x^2 + x) + f(x^2) = f(x^2) f(x + 1) + f(x^2 + x + 1). \]
By~\eqref{2012a5-eq3-1},~\eqref{2012a5-eq3-2}, and some rearranging, we get
\[ f(x) f(x^2 + x) = (f(x + 1)^2 - 1)(f(x + 1) - 1) + f(x) f(x + 1). \tag{3.3}\label{2012a5-eq3-3} \]
Next, we prove that for any $x \in R$,
\[ f(x)^2 + f(x + 1)^2 = 1 \vee f(x) + f(x + 1) = 1. \tag{3.4}\label{2012a5-eq3-4} \]

\begin{proof}
Write $f(x) f(x + 1) f(x^2 + x)$ in two ways using~\eqref{2012a5-eq3-3}:
\[ f(x + 1) ((f(x + 1)^2 - 1)(f(x + 1) - 1) + f(x) f(x + 1)) = f(x) ((f(x)^2 - 1)(f(x) - 1) + f(x + 1) f(x)). \]
Note that this can be regarded as an equality in commutative rings since $f(x)$ and $f(x + 1)$ commute.
Rearranging yields
\[ (f(x + 1) - f(x))(f(x)^2 + f(x + 1)^2 - 1)(f(x) + f(x + 1) - 1) = 0. \]
So either~\eqref{2012a5-eq3-4} holds, or $f(x + 1) = f(x)$.

In the latter case,~\eqref{2012a5-eq3-3} becomes $f(x) f(x^2 + x) = f(x)^3 - f(x) + 1$.
Note that by~\eqref{2012a5-eq3-1} and~\eqref{2012a5-eq3-2},
\[ f(x^2 + x)^2 = f(x^4 + x^2 + 1) + 1 = f(x^2) f(x^2 + 1) + 1 = (f(x)^2 - 1)^2 + 1. \]
For convenience, if we denote $f(x) = c$, we get
\[ c^2 (c^4 - 2c^2 + 2) = (c^3 - c + 1)^2 \iff (1 - 2c)(c^2 - 1) = 0. \]
If $2c = 1$, then we are done as $f(x) + f(x + 1) = 2c$.
Otherwise, $f(x^2) = f(x^2 + 1) = c^2 - 1 = 0$.
Plugging back into~\eqref{2012a5-eq3-3} with $x$ replaced by $x^2$ yields a contradiction.
\end{proof}

In particular, if $\rchar(S) \mid 2$, we are done.
Indeed,~\eqref{2012a5-eq3-4} yields $f(x + 1) = f(x) + 1$ for all $x \in R$.
Then Lemma~\ref{2012a5-linear-solver} yields that $f + 1$ is a ring homomorphism.
Thus, from now on, we assume that $\rchar(S) \nmid 2$.

The next statement we prove is
\[ f(x) = 0 \vee f(x + 1) = 0 \vee (f(x) + f(x + 1) = 1 \wedge f(x) f(x + 1) = -1). \tag{3.5}\label{2012a5-eq3-5} \]

\begin{proof}
First notice that by double application of~\eqref{2012a5-eq3-2}, for any $x \in R$,
\[ f(x^4) = (f(x)^2 - 1)^2 - 1 = f(x)^4 - 2 f(x)^2. \]
Now write $f(x^8 + x^4 + 1)$ in two ways, using the above and using~\eqref{2012a5-eq3-1}.
Since $f(x^2 + x + 1) = f(x) f(x + 1)$, we get
\[ (f(x)^4 - 2 f(x)^2)(f(x + 1)^4 - 2 f(x + 1)^2) = (f(x) f(x + 1))^4 - 2 (f(x) f(x + 1))^2, \]
    which rearranges to
\[ (f(x) f(x + 1))^2 (f(x)^2 + f(x + 1)^2 - 3) = 0 \iff f(x) = 0 \vee f(x + 1) = 0 \vee f(x)^2 + f(x + 1)^2 = 3. \]
The last case, by~\eqref{2012a5-eq3-4}, also implies $f(x) + f(x + 1) = 1$, as $f(x)^2 + f(x + 1)^2 = 1$ is impossible.
Then expanding $(f(x) + f(x + 1))^2$ and simplifying yields $f(x) f(x + 1) = -1$, as desired.
\end{proof}

By~\eqref{2012a5-eq3-3}, if $f(x) = 0$, we know that $f(x + 1) = \pm 1$.
On the other hand,~\eqref{2012a5-eq3-5} gives us the converse, so we have
\[ f(x) = 0 \iff f(x + 1) = \pm 1. \tag{3.6}\label{2012a5-eq3-6} \]
Next, we prove the following:
\[ f(r) = -1 \implies r = 0. \tag{3.7}\label{2012a5-eq3-7} \]

\begin{proof}
By~\eqref{2012a5-eq3-6}, $f(r) = -1$ implies $f(r + 1) = 0$.
Plugging into~\eqref{2012a5-eq3-2} yields $f(r^2) = -1$.
Meanwhile, plugging back into~\eqref{2012a5-eq3-3} gives $f(r^2 + r) = -1$.
Note again that this holds for any $r \in R$ such that $f(r) = -1$.

Plugging into~\eqref{2012a5-eq0} yields $f(rx + 1) = f(x + r) - f(r)$ for any $x \in R$.
This also yields $f(r^2 + rx + 1) = -f(rx + 1)$ since $\rchar(R) \mid 2$.
In particular, for any $y \in R$ of form $rx + 1$ for some $x$, we have $f(r^2 + y) = -f(y)$.

Apply the same reasoning with $r^2$ and $r^2 + r$ in place of $r$.
For the former, we have $f(r^4 + y) = -f(y)$ if $y$ is of form $r^2 x + 1$.
These numbers are also of form $rx + 1$ for some $x \in R$, so we get $f(r^4 + r^2 + y) = -f(r^2 + y) = f(y)$.
On the other hand, we have $f(r^4 + r^2 + y) = -f(y)$ if $y$ is of form $(r^2 + r) x + 1$ for some $x \in R$.
Thus, since $\rchar(S) \nmid 2$, this implies $f(y) = 0$ if $y$ is of both forms.
In particular, $f((r^3 + r^2) x + 1) = 0$ for all $r \in R$, so $r^3 + r^2$ is quasi-perodic.
The same holds for $r^4 + r^2 = (r^3 + r^2)(r + 1)$.
Since $f(r) = -1 \implies f(r^2) = -1 \implies f(r^4 + r^2) = -1$, we get $r^4 + r^2 = 0$.

Now go back to the equality $f(r^4 + r^2 + y) = -f(y)$, which holds whenever $y$ is of form $(r^2 + r) x + 1$ for some $x \in R$.
Since $r^4 + r^2 = 0$, this yields $f((r^2 + r) x + 1) = 0$ for all $x \in R$, so $r^2 + r$ is quasi-periodic.
Since $f(r^2 + r) = -1$, we get $r^2 + r = 0$.
Finally,~\eqref{2012a5-eq0} yields that for any $x \in R$,
\[ 0 = f((r + 1)rx + 1) = f(rx + r + 1) = f(r(x + 1) + 1). \]
So $r$ is quasi-periodic.
Since $f(r) = -1$, this gives $r = 0$, as desired.
\end{proof}

As a result, these are the following possible cases for an element $r \in R$:
\begin{itemize}
    \item   $r = 0$ or $r = 1$;
    \item   $(f(r), f(r + 1)) = (1, 0)$, for which $r^2 = 0$ but $r \neq 0$;
    \item   $(f(r), f(r + 1)) = (0, 1)$, for which $r^2 = 1$ but $r \neq 1$;
    \item   $f(r) + f(r + 1) = 1$ and $f(r) f(r + 1) = -1$, for which $r^2 + r + 1 = 0$.
\end{itemize}

Note that $r$ falls into the second category if and only if $r + 1$ falls into the third category.
Thus, in the ring $R$, every element $r$ either satisfies $r^2 = 0$, $r^2 = 1$, or $r^2 + r + 1 = 0$.
Furthermore,

\begin{itemize}
    \item   $r^2 = 0$ if and only if $f(r + 1) = 0$.
            If $r = 0$, then $f(r) = -1$; otherwise $f(r) = 1$.
    \item   $r^2 = 1$ iff $(r + 1)^2 = 0$ iff $f(r) = 0$.
    \item   $r^2 + r + 1 = 0$ iff $f(r) + f(r + 1) = 1$ and $f(r) f(r + 1) = -1$.
\end{itemize}

We now analyze such rings and in fact show that it is isomorphic to $\F_2$, $\F_2[\varepsilon]$, or $\F_4$.
More explicitly,

\begin{itemize}
    \item   Given $r \in R$ such that $r \neq 0$ but $r^2 = 0$, we construct an isomorphism $R \cong \F_2[\varepsilon]$.
            As such $r$ satisfies $f(r) = 1$ and $f(r + 1) = 0$, the isomorphism induces the fifth map ($\F_2[\varepsilon] \to \Z$) on the table.
    \item   On the other hand, given $r \in R$ such that $r^2 + r + 1 = 0$, we construct an isomorphism $R \cong \F_4$.
            The isomorphism induces the sixth map ($\F_4 \to \Z[\varphi]$) on the table.
    \item   Otherwise, we would have $R = \{0, 1\}$.
            Then $R \cong \F_2$ and the isomorphism induces the first map ($\F_2 \to \Z$) on the table.
\end{itemize}

\begin{claim}
Given $r, s \in R$ non-zero such that $r^2 = s^2 = 0$, we have $r = s$.
\end{claim}
\begin{proof}
We first show that $(rs)^2 = 0$.
We see that $(r + s)^2 = rs + sr$, and it equals either $0$, $1$, or $r + s + 1$.
In the first case, we get $rs = sr$, and so $(rs)^2 = sr^2 s = 0$.
In the second case, $rs = sr + 1$, so $(rs)^2 = rs \neq rs + 1$, and thus $rs \in \{0, 1\}$.
Since $r^2 s = 0 \neq r$, we get $rs = 0$.
But then $sr = 1$ and $0 = sr^2 = r$; a contradiction.
In the third case, we have $0 = r(rs + sr)r = rsr$.
Then $0 = r(rs + sr) = r(r + s + 1) = rs + r$, so $rs = r$.
Similarly, $0 = (rs + sr)r = (r + s + 1)r = sr + r$, so $sr = r$.
But then $rs + sr = 0 \implies s = r + 1$, which is also impossible since $r^2 = s^2 = 0$.
This shows that $(rs)^2 = 0$.

Now we go back to the functional equation.
Since $(rs)^2 = 0$, we have $f(r) f(s) + f(r + s) = f(rs + 1) = 0$.
But $f(r) = f(s) = 1$ since $r^2 = s^2 = 0$ but $r, s \neq 0$.
Thus we get $f(r + s) = -1 \implies r + s = 0$, i.e. $r = s$, as desired.
\end{proof}

\begin{claim}
Given $r, s \in R$ such that $r^2 = 0$ and $s^2 + s + 1 = 0$, we have $r = 0$.
\end{claim}
\begin{proof}
Suppose for the sake of contradiction that $r \neq 0$.
Note that $s^2 + s + 1 = 0$ yields $s \notin \{0, 1, r, r + 1\}$.
If $(r + s)^2 = 0$, then the previous claim yields $s = r$; a contradiction.
Similarly, $(r + s + 1)^2 = 0$ yields $s = r + 1$, which is also a contradiction.
The remaining case to consider is $(r + s)^2 = r + s + 1$, which rewrites as $rs + sr = r$.

In this case, we have $rsr = r(rs + sr) = r^2 = 0$, so $(rs)^2 = 0$.
By the previous claim, we get $rs \in \{0, r\}$.
Since $s$ is invertible in $R$ (the inverse is $s + 1$), $rs = 0$ yields $r = 0$.
Meanwhile, $rs = r$ yields $r(s + 1) = 0$ and again, $r = 0$.
The claim is proved.
\end{proof}

We now finish the solution.
Given $r \in R$ with $r \neq 0$ and $r^2 = 0$, the second claim yield that $s^2 \in \{0, 1\}$ for any $s \in R$.
If $s^2 = 0$, then $s \in \{0, r\}$, so $R = \{0, 1, r, r + 1\} \cong \F_2[\varepsilon]$.
So now, suppose that there exists $r \in R$ with $r^2 + r + 1 = 0$.

The second claim yield that for any $s \in R$, either $s = 0$, $s = 1$, or $s^2 + s + 1 = 0$.
Similarly, $r + s \in \{0, 1\}$ or $(r + s)^2 + (r + s) + 1 = 0$.
Now we prove that $s^2 + s + 1 = (r + s)^2 + (r + s) + 1 = 0$ cannot happen, thus $R = \{0, 1, s, s + 1\} \cong \F_4$.

Indeed, if $s^2 + s + 1 = 0$, then $(r + s)^2 + (r + s) + 1 = rs + sr + 1$.
Now suppose that the latter equals zero, i.e., $rs + sr = 1$.
Since both $r$ and $s$ are invertible, $rs \neq 0$.
If $rs = 1$, then $r = s + 1$ and so, we get $sr = 1$ and $rs + sr = 0$; a contradiction.
Finally, suppose that $(rs)^2 = rs + 1 = sr$.
Then we get
\[ 1 = (rs)^3 = sr^2 s = srs + s^2 = srs + s + 1 \implies (sr + 1) s = 0 \implies rs^2 = 0. \]
Impossible, since $r$ and $s$ are invertible.
This shows that $R \cong \F_4$, and we are done.



\subsection*{Implementation details}

This is a huge proof, so naturally the code has to be split up into several files.
\begin{itemize}
    \item   The file \texttt{A5Defs.lean} contains all the definitions and a few small results.
    \item   The folder \texttt{A5Answers/} contains all the building blocks needed to describe the set of answers.
            The file \texttt{SubOneMap.lean} in the folder also contains Lemma~\ref{2012a5-linear-solver}, the $f(x + 1) = f(x) + 1$ solver.
            The file \texttt{ZeroMap.lean} in the folder contains the proof that $f$ is either the zero map or non-trivial.
    \item   The folder \texttt{A5General/} contains more general lemmas: quasi-periodic and periodic elements, transferring good maps via ring homomorphism, and lifting good maps to commutative rings/integral domains, which is used implicitly throughout the solution.
    \item   The folder \texttt{A5Cases/} contains complete solutions to each of the three cases.
    \item   Finally, the file \texttt{A5.lean} summarizes the whole solution.
\end{itemize}



\subsection*{Further directions}

This is already a very big generalization.
There are still options for more generalization, but they add too much complexity.
Perhaps the most reasonable option is to weaken the condition on $S$ to just be a reduced ring.
Note that weakening $S$ to be a reduced commutative ring does not increase the generality of the solution in any meaningful way, because such rings always embed into product of domains.
